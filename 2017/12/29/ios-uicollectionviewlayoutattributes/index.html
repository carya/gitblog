
<!DOCTYPE html>
<html lang="en,zh-CN,default">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="CaryaLiu&#39;s blog">
    <title>UICollectionViewLayoutAttributes初探 - CaryaLiu&#39;s blog</title>
    <meta name="author" content="CaryaLiu">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"CaryaLiu","sameAs":[],"image":"header.png"},"articleBody":"UICollectionViewLayoutAttributes是UICollectionView的重要组成部分，本文从其基本定义、如何使用以及使用场景几方面来简单介绍。文末以自定义UICollectionView各个Section的背景色的示例来展示UICollectionViewLayoutAttributes的应用。\n\n\nUICollectionViewLayoutAttributes概览UICollectionViewLayoutAttributes的官方解释：\n\nA layout object that manages the layout-related attributes for a given item in a collection view.Layout objects create instances of this class when asked to do so by the collection view. In turn, the collection view uses the layout information to position cells and supplementary views inside its bounds.\n\nUICollectionViewLayoutAttributes是管理collection view中指定元素的布局属性的对象。collection view使用该对象中的布局属性来控制cells和supplementary views的显示位置。\n下面是UICollectionViewLayoutAttributes类的定义:\n123456789101112131415161718192021NS_CLASS_AVAILABLE_IOS(6_0) @interface UICollectionViewLayoutAttributes : NSObject &lt;NSCopying, UIDynamicItem&gt;@property (nonatomic) CGRect frame;@property (nonatomic) CGPoint center;@property (nonatomic) CGSize size;@property (nonatomic) CATransform3D transform3D;@property (nonatomic) CGRect bounds NS_AVAILABLE_IOS(7_0);@property (nonatomic) CGAffineTransform transform NS_AVAILABLE_IOS(7_0);@property (nonatomic) CGFloat alpha;@property (nonatomic) NSInteger zIndex; // default is 0@property (nonatomic, getter=isHidden) BOOL hidden; // As an optimization, UICollectionView might not create a view for items whose hidden attribute is YES@property (nonatomic, strong) NSIndexPath *indexPath;@property (nonatomic, readonly) UICollectionElementCategory representedElementCategory;@property (nonatomic, readonly, nullable) NSString *representedElementKind; // nil when representedElementCategory is UICollectionElementCategoryCell+ (instancetype)layoutAttributesForCellWithIndexPath:(NSIndexPath *)indexPath;+ (instancetype)layoutAttributesForSupplementaryViewOfKind:(NSString *)elementKind withIndexPath:(NSIndexPath *)indexPath;+ (instancetype)layoutAttributesForDecorationViewOfKind:(NSString *)decorationViewKind withIndexPath:(NSIndexPath *)indexPath;@end\n\n其中UICollectionElementCategory的定义如下：\n12345typedef NS_ENUM(NSUInteger, UICollectionElementCategory) &#123;    UICollectionElementCategoryCell,    UICollectionElementCategorySupplementaryView,    UICollectionElementCategoryDecorationView&#125;;\n\n\nBecause layout attribute objects may be copied by the collection view, it conforms to the NSCopying protocol. It is very important that we also conform to this protocol and implement copyWithZone:. Otherwise, our property will always be zero (as guaranteed by the compiler). \n\n由于layout attributes对象可能会被collection view复制，因此layout attributes对象应该遵循NSCoping协议，并实现copyWithZone:方法，否则我们获取的自定义属性会一直是空值。\n\nIf you subclass and implement any custom layout attributes, you must also override the inherited isEqual: method to compare the values of your properties. In iOS 7 and later, the collection view does not apply layout attributes if those attributes have not changed. It determines whether the attributes have changed by comparing the old and new attribute objects using the isEqual: method. Because the default implementation of this method checks only the existing properties of this class, you must implement your own version of the method to compare any additional properties. If your custom properties are all equal, call super and return the resulting value at the end of your implementation.\n\n如果继承了UICollectionViewLayoutAttributes并且添加了任何自定义的layout attributes，也必须实现isEqual:方法来比较自定义属性。在iOS7(包括iOS7)以后，如果UICollectionViewLayoutAttributes 的属性值没有改变，collection view不会应用layout attributes，这些layout attributes的是否改变由isEqual:的返回值来决定。在重写isEqual:时，除了需要处理自定义属性外，还需要注意父类方法的调用。如下所示：\n1234567891011121314151617181920/** subclass must conforms to the NSCopying protocol */- (id)copyWithZone:(NSZone *)zone &#123;        CLSectionColorLayoutAttributes *layoutAttributes = [super copyWithZone:zone];    layoutAttributes.sectionColor = self.sectionColor;    return layoutAttributes;&#125;/** In iOS 7 and later, the collection view does not apply layout attributes if those attributes have not changed. It determines whether the attributes have changed by comparing the old and new attribute objects using the isEqual: method. */- (BOOL)isEqual:(id)object &#123;    if (self == object) &#123;        return YES;    &#125;    if ([object class] == [self class]) &#123;        return [super isEqual:object] &amp;&amp; (self.sectionColor == [object sectionColor]);    &#125;    return NO;&#125;\n\nSubclassing Notes首先，在UICollectionViewLayoutAttributes的子类中重写copyWithZone:方法和isEqual:方法。其原因已在上一节讲到。\n接下来需要告诉collection view使用自定义的类而不是系统的UICollectionViewLayoutAttributes类，需要在自定义的CLCollectionViewFlowLayout中重写类方法+(Class)layoutAttributesClass，如下所示：\n123+ (Class)layoutAttributesClass &#123;    return [CLSectionColorLayoutAttributes class];&#125;\n\n为了与系统的配置属性使用保持一致，我们可以在CLCollectionViewFlowLayout头文件中暴露自定义属性，以便对该属性的统一设置。如下：\n12345678.h@property (nonatomic, strong) UIColor *sectionColor;.m- (void)setSectionColor:(UIColor *)sectionColor &#123;    _sectionColor = sectionColor;    [self invalidateLayout];&#125;\n\n同时，为了达到与系统的UICollectionViewDelegateFlowLayout使用达到一致，可以支持自定义属性针对不同indexPath的设置，我们声明protocol以供业务层调用，如下：\n1234567@protocol CLCollectionViewDelegateFlowLayout &lt;UICollectionViewDelegateFlowLayout&gt;@optional- (UIColor *)collectionView:(UICollectionView *)collectionView                     layout:(UICollectionViewLayout *)collectionViewLayout     colorForSectionAtIndex:(NSInteger)section;@end\n\n这里需要注意，我们自定义的协议遵循了UICollectionViewDelegateFlowLayout协议,且无需在CLCollectionViewFlowLayout类中声明一个遵循该协议的delegate对象，该协议的使用与UICollectionViewDelegateFlowLayout一致。layout的实现文件中优先使用该协议返回的值，否则使用属性中传入的值。如下：\n123456789- (UIColor *)sectionColorAtSection:(NSInteger)section &#123;    UIColor *sectionColor = self.sectionColor;    //if implemented collectionView:layout:colorForSectionAtIndex: use the return value    if ([self.collectionView.delegate respondsToSelector:@selector(collectionView:layout:colorForSectionAtIndex:)]) &#123;        id&lt;CLCollectionViewDelegateFlowLayout&gt; temp = (id&lt;CLCollectionViewDelegateFlowLayout&gt;)self.collectionView.delegate;        sectionColor = [temp collectionView:self.collectionView layout:self colorForSectionAtIndex:section];    &#125;    return sectionColor;&#125;\n\nsectionColorAtSection:方法会在layoutAttributesForDecorationViewOfKind:atIndexPath:中调用。\n至此，自定义属性传递给了layout，但是是怎样应用到具体的Cell或者SupplementaryView上的呢？继承自UICollectionReusableView或者UICollectionViewCell的控制，包含如下方法：\n12345// Classes that want to support custom layout attributes specific to a given UICollectionViewLayout subclass can apply them here.// This allows the view to work in conjunction with a layout class that returns a custom subclass of UICollectionViewLayoutAttributes from -layoutAttributesForItem: or the corresponding layoutAttributesForHeader/Footer methods.// -applyLayoutAttributes: is then called after the view is added to the collection view and just before the view is returned from the reuse queue.// Note that -applyLayoutAttributes: is only called when attributes change, as defined by -isEqual:.- (void)applyLayoutAttributes:(UICollectionViewLayoutAttributes *)layoutAttributes;\n\n例如如下的实现：\n1234567- (void)applyLayoutAttributes:(UICollectionViewLayoutAttributes *)layoutAttributes &#123;    [super applyLayoutAttributes:layoutAttributes];    if ([layoutAttributes isKindOfClass:[CLSectionColorLayoutAttributes class]]) &#123;        CLSectionColorLayoutAttributes *attributes = (CLSectionColorLayoutAttributes *)layoutAttributes;        self.backgroundColor = attributes.sectionColor;    &#125;&#125;\n\n\nThis method belongs to UICollectionReusableView because layout attributes are applicable to cells, supplementary views, and decoration views. First, you must call super’s implementation. Next, it checks to ensure that the layout attributes are an instance of our custom subclass before casting the pointer.\n\n注意：该方法声明在UICollectionReusableView类中，适用于cells、supplementary view、decoration views。首先你必须调用父类的实现，然后检查layoutAttributes是否自定义类的实例，来决定是否进行指针的强制转换。\n自定义UICollectionView各个Section的背景色前面讲解了UICollectionViewLayoutAttributes的基本使用，使用的示例代码是为了能够达到自定义UICollectionView的各个Section的背景色。你可能对这个需求有疑惑，在UICollectionView中，每个Section中可以定义sectionInset、minimumLineSpacing、minimumInteritemSpacing属性值，而这些属性值定义的空白区域的背景色是与UICollectionView的背景色保持一致，当我们的需求中需要定义与UICollectionView的背景色不一致时，或者各个Section定义的背景色也各有区别时，\n为了达到此目的，方案是在各个section中添加decoration view，然后设置decoration view的颜色就是各个section的背景色，具体的代码见github中下载,如有错误之处，欢迎指正。\n需要重点提出的是，如果你想在删除cell或者section的时候动态添加或者删除decoration view，你可能需要花点功夫来使cell的添加或者删除动画与decoration view的添加与删除动画保持同步。\n\nfooterReferenceSize and headerReferenceSize During layout, only the size that corresponds to the appropriate scrolling direction is used. For example, for the vertical scrolling direction, the layout object uses the height value returned by your method. (In that instance, the width of the header would be set to the width of the collection view.) If the size in the appropriate scrolling dimension is 0, no header is added.\n\n使用场景UICollectionViewLayoutAttributes使用场景，个人总结如下：1.与DataSource无关，但想控制UIReusableView或者UICollectionViewCell的显示属性，例如在ViewController中配置UIImageView的显示模式。2.UICollectionviewCell的某一属性需要跟随UICollectionViewLayout的改变而改变，例如CoverFlow类型的展示。\n\n如果觉得本文对你有帮助，就请用微信随意打赏我吧^_^\n\n","dateCreated":"2017-12-29T22:51:09+08:00","dateModified":"2021-04-18T11:48:08+08:00","datePublished":"2017-12-29T22:51:09+08:00","description":"UICollectionViewLayoutAttributes是UICollectionView的重要组成部分，本文从其基本定义、如何使用以及使用场景几方面来简单介绍。文末以自定义UICollectionView各个Section的背景色的示例来展示UICollectionViewLayoutAttributes的应用。","headline":"UICollectionViewLayoutAttributes初探","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://liumh.com/2017/12/29/ios-uicollectionviewlayoutattributes/"},"publisher":{"@type":"Organization","name":"CaryaLiu","sameAs":[],"image":"header.png","logo":{"@type":"ImageObject","url":"header.png"}},"url":"http://liumh.com/2017/12/29/ios-uicollectionviewlayoutattributes/","keywords":"iOS, UICollectionViewLayoutAttributes, UICollectionView"}</script>
    <meta name="description" content="UICollectionViewLayoutAttributes是UICollectionView的重要组成部分，本文从其基本定义、如何使用以及使用场景几方面来简单介绍。文末以自定义UICollectionView各个Section的背景色的示例来展示UICollectionViewLayoutAttributes的应用。">
<meta property="og:type" content="blog">
<meta property="og:title" content="UICollectionViewLayoutAttributes初探">
<meta property="og:url" content="http://liumh.com/2017/12/29/ios-uicollectionviewlayoutattributes/index.html">
<meta property="og:site_name" content="CaryaLiu&#39;s blog">
<meta property="og:description" content="UICollectionViewLayoutAttributes是UICollectionView的重要组成部分，本文从其基本定义、如何使用以及使用场景几方面来简单介绍。文末以自定义UICollectionView各个Section的背景色的示例来展示UICollectionViewLayoutAttributes的应用。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://liumh.com/img/wechat_appreciate_qrcode.jpeg">
<meta property="article:published_time" content="2017-12-29T14:51:09.000Z">
<meta property="article:modified_time" content="2021-04-18T03:48:08.000Z">
<meta property="article:author" content="CaryaLiu">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="UICollectionViewLayoutAttributes">
<meta property="article:tag" content="UICollectionView">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://liumh.com/img/wechat_appreciate_qrcode.jpeg">
    
    
        
    
    
        <meta property="og:image" content="http://liumh.com/assets/images/header.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-zpenvh5cbgb1vzzlq3akzblrroxrej3zx0naeyxu1vn9s3kx3bsq9s1rbqce.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            CaryaLiu&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">CaryaLiu</h4>
                
                    <h5 class="sidebar-profile-bio"><p>@Chengdu，WeChat：CaryaLiu</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            UICollectionViewLayoutAttributes初探
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2017-12-29T22:51:09+08:00">
	
		    Dec 29, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>UICollectionViewLayoutAttributes是UICollectionView的重要组成部分，本文从其基本定义、如何使用以及使用场景几方面来简单介绍。文末以自定义UICollectionView各个Section的背景色的示例来展示UICollectionViewLayoutAttributes的应用。</p>
<span id="more"></span>

<h1 id="UICollectionViewLayoutAttributes概览"><a href="#UICollectionViewLayoutAttributes概览" class="headerlink" title="UICollectionViewLayoutAttributes概览"></a>UICollectionViewLayoutAttributes概览</h1><p>UICollectionViewLayoutAttributes的官方解释：</p>
<blockquote>
<p>A layout object that manages the layout-related attributes for a given item in a collection view.Layout objects create instances of this class when asked to do so by the collection view. In turn, the collection view uses the layout information to position cells and supplementary views inside its bounds.</p>
</blockquote>
<p>UICollectionViewLayoutAttributes是管理collection view中指定元素的布局属性的对象。collection view使用该对象中的布局属性来控制cells和supplementary views的显示位置。</p>
<p>下面是UICollectionViewLayoutAttributes类的定义:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">NS_CLASS_AVAILABLE_IOS(6_0) @interface UICollectionViewLayoutAttributes : NSObject &lt;NSCopying, UIDynamicItem&gt;</span><br><span class="line"></span><br><span class="line">@property (nonatomic) CGRect frame;</span><br><span class="line">@property (nonatomic) CGPoint center;</span><br><span class="line">@property (nonatomic) CGSize size;</span><br><span class="line">@property (nonatomic) CATransform3D transform3D;</span><br><span class="line">@property (nonatomic) CGRect bounds NS_AVAILABLE_IOS(7_0);</span><br><span class="line">@property (nonatomic) CGAffineTransform transform NS_AVAILABLE_IOS(7_0);</span><br><span class="line">@property (nonatomic) CGFloat alpha;</span><br><span class="line">@property (nonatomic) NSInteger zIndex; // default is 0</span><br><span class="line">@property (nonatomic, getter=isHidden) BOOL hidden; // As an optimization, UICollectionView might not create a view for items whose hidden attribute is YES</span><br><span class="line">@property (nonatomic, strong) NSIndexPath *indexPath;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, readonly) UICollectionElementCategory representedElementCategory;</span><br><span class="line">@property (nonatomic, readonly, nullable) NSString *representedElementKind; // nil when representedElementCategory is UICollectionElementCategoryCell</span><br><span class="line"></span><br><span class="line">+ (instancetype)layoutAttributesForCellWithIndexPath:(NSIndexPath *)indexPath;</span><br><span class="line">+ (instancetype)layoutAttributesForSupplementaryViewOfKind:(NSString *)elementKind withIndexPath:(NSIndexPath *)indexPath;</span><br><span class="line">+ (instancetype)layoutAttributesForDecorationViewOfKind:(NSString *)decorationViewKind withIndexPath:(NSIndexPath *)indexPath;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>其中UICollectionElementCategory的定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSUInteger, UICollectionElementCategory) &#123;</span><br><span class="line">    UICollectionElementCategoryCell,</span><br><span class="line">    UICollectionElementCategorySupplementaryView,</span><br><span class="line">    UICollectionElementCategoryDecorationView</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Because layout attribute objects may be copied by the collection view, it conforms to the <code>NSCopying</code> protocol. It is very important that we also conform to this protocol and implement <code>copyWithZone:</code>. Otherwise, our property will always be zero (as guaranteed by the compiler). </p>
</blockquote>
<p>由于layout attributes对象可能会被collection view复制，因此layout attributes对象应该遵循<code>NSCoping</code>协议，并实现<code>copyWithZone:</code>方法，否则我们获取的自定义属性会一直是空值。</p>
<blockquote>
<p>If you subclass and implement any custom layout attributes, you must also override the inherited <code>isEqual:</code> method to compare the values of your properties. In iOS 7 and later, the collection view does not apply layout attributes if those attributes have not changed. It determines whether the attributes have changed by comparing the old and new attribute objects using the <code>isEqual:</code> method. Because the default implementation of this method checks only the existing properties of this class, you must implement your own version of the method to compare any additional properties. If your custom properties are all equal, call super and return the resulting value at the end of your implementation.</p>
</blockquote>
<p>如果继承了UICollectionViewLayoutAttributes并且添加了任何自定义的layout attributes，也必须实现<code>isEqual:</code>方法来比较自定义属性。在iOS7(包括iOS7)以后，如果UICollectionViewLayoutAttributes 的属性值没有改变，collection view不会应用layout attributes，这些layout attributes的是否改变由<code>isEqual:</code>的返回值来决定。在重写<code>isEqual:</code>时，除了需要处理自定义属性外，还需要注意父类方法的调用。如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/** subclass must conforms to the NSCopying protocol */</span><br><span class="line">- (id)copyWithZone:(NSZone *)zone &#123;</span><br><span class="line">    </span><br><span class="line">    CLSectionColorLayoutAttributes *layoutAttributes = [super copyWithZone:zone];</span><br><span class="line">    layoutAttributes.sectionColor = self.sectionColor;</span><br><span class="line">    return layoutAttributes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/** In iOS 7 and later, the collection view does not apply layout attributes if</span><br><span class="line"> those attributes have not changed. It determines whether the attributes have changed</span><br><span class="line"> by comparing the old and new attribute objects using the isEqual: method. */</span><br><span class="line">- (BOOL)isEqual:(id)object &#123;</span><br><span class="line">    if (self == object) &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    if ([object class] == [self class]) &#123;</span><br><span class="line">        return [super isEqual:object] &amp;&amp; (self.sectionColor == [object sectionColor]);</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Subclassing-Notes"><a href="#Subclassing-Notes" class="headerlink" title="Subclassing Notes"></a>Subclassing Notes</h1><p>首先，在UICollectionViewLayoutAttributes的子类中重写<code>copyWithZone:</code>方法和<code>isEqual:</code>方法。其原因已在上一节讲到。</p>
<p>接下来需要告诉collection view使用自定义的类而不是系统的UICollectionViewLayoutAttributes类，需要在自定义的CLCollectionViewFlowLayout中重写类方法<code>+(Class)layoutAttributesClass</code>，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (Class)layoutAttributesClass &#123;</span><br><span class="line">    return [CLSectionColorLayoutAttributes class];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了与系统的配置属性使用保持一致，我们可以在CLCollectionViewFlowLayout头文件中暴露自定义属性，以便对该属性的统一设置。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.h</span><br><span class="line">@property (nonatomic, strong) UIColor *sectionColor;</span><br><span class="line"></span><br><span class="line">.m</span><br><span class="line">- (void)setSectionColor:(UIColor *)sectionColor &#123;</span><br><span class="line">    _sectionColor = sectionColor;</span><br><span class="line">    [self invalidateLayout];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时，为了达到与系统的<code>UICollectionViewDelegateFlowLayout</code>使用达到一致，可以支持自定义属性针对不同indexPath的设置，我们声明protocol以供业务层调用，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@protocol CLCollectionViewDelegateFlowLayout &lt;UICollectionViewDelegateFlowLayout&gt;</span><br><span class="line"></span><br><span class="line">@optional</span><br><span class="line">- (UIColor *)collectionView:(UICollectionView *)collectionView</span><br><span class="line">                     layout:(UICollectionViewLayout *)collectionViewLayout</span><br><span class="line">     colorForSectionAtIndex:(NSInteger)section;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>这里需要注意，我们自定义的协议遵循了UICollectionViewDelegateFlowLayout协议,且无需在CLCollectionViewFlowLayout类中声明一个遵循该协议的delegate对象，该协议的使用与UICollectionViewDelegateFlowLayout一致。layout的实现文件中优先使用该协议返回的值，否则使用属性中传入的值。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (UIColor *)sectionColorAtSection:(NSInteger)section &#123;</span><br><span class="line">    UIColor *sectionColor = self.sectionColor;</span><br><span class="line">    //if implemented collectionView:layout:colorForSectionAtIndex: use the return value</span><br><span class="line">    if ([self.collectionView.delegate respondsToSelector:@selector(collectionView:layout:colorForSectionAtIndex:)]) &#123;</span><br><span class="line">        id&lt;CLCollectionViewDelegateFlowLayout&gt; temp = (id&lt;CLCollectionViewDelegateFlowLayout&gt;)self.collectionView.delegate;</span><br><span class="line">        sectionColor = [temp collectionView:self.collectionView layout:self colorForSectionAtIndex:section];</span><br><span class="line">    &#125;</span><br><span class="line">    return sectionColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sectionColorAtSection:</code>方法会在<code>layoutAttributesForDecorationViewOfKind:atIndexPath:</code>中调用。</p>
<p>至此，自定义属性传递给了layout，但是是怎样应用到具体的Cell或者SupplementaryView上的呢？继承自UICollectionReusableView或者UICollectionViewCell的控制，包含如下方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Classes that want to support custom layout attributes specific to a given UICollectionViewLayout subclass can apply them here.</span><br><span class="line">// This allows the view to work in conjunction with a layout class that returns a custom subclass of UICollectionViewLayoutAttributes from -layoutAttributesForItem: or the corresponding layoutAttributesForHeader/Footer methods.</span><br><span class="line">// -applyLayoutAttributes: is then called after the view is added to the collection view and just before the view is returned from the reuse queue.</span><br><span class="line">// Note that -applyLayoutAttributes: is only called when attributes change, as defined by -isEqual:.</span><br><span class="line">- (void)applyLayoutAttributes:(UICollectionViewLayoutAttributes *)layoutAttributes;</span><br></pre></td></tr></table></figure>

<p>例如如下的实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)applyLayoutAttributes:(UICollectionViewLayoutAttributes *)layoutAttributes &#123;</span><br><span class="line">    [super applyLayoutAttributes:layoutAttributes];</span><br><span class="line">    if ([layoutAttributes isKindOfClass:[CLSectionColorLayoutAttributes class]]) &#123;</span><br><span class="line">        CLSectionColorLayoutAttributes *attributes = (CLSectionColorLayoutAttributes *)layoutAttributes;</span><br><span class="line">        self.backgroundColor = attributes.sectionColor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>This method belongs to UICollectionReusableView because layout attributes are applicable to cells, supplementary views, and decoration views. First, you must call super’s implementation. Next, it checks to ensure that the layout attributes are an instance of our custom subclass before casting the pointer.</p>
</blockquote>
<p>注意：该方法声明在UICollectionReusableView类中，适用于cells、supplementary view、decoration views。首先你必须调用父类的实现，然后检查layoutAttributes是否自定义类的实例，来决定是否进行指针的强制转换。</p>
<h1 id="自定义UICollectionView各个Section的背景色"><a href="#自定义UICollectionView各个Section的背景色" class="headerlink" title="自定义UICollectionView各个Section的背景色"></a>自定义UICollectionView各个Section的背景色</h1><p>前面讲解了UICollectionViewLayoutAttributes的基本使用，使用的示例代码是为了能够达到自定义UICollectionView的各个Section的背景色。你可能对这个需求有疑惑，在UICollectionView中，每个Section中可以定义sectionInset、minimumLineSpacing、minimumInteritemSpacing属性值，而这些属性值定义的空白区域的背景色是与UICollectionView的背景色保持一致，当我们的需求中需要定义与UICollectionView的背景色不一致时，或者各个Section定义的背景色也各有区别时，</p>
<p>为了达到此目的，方案是在各个section中添加decoration view，然后设置decoration view的颜色就是各个section的背景色，具体的代码见<br><a target="_blank" rel="noopener" href="https://github.com/carya/SectionBackgroundColor">github</a>中下载,如有错误之处，欢迎指正。</p>
<p>需要重点提出的是，如果你想在删除cell或者section的时候动态添加或者删除decoration view，你可能需要花点功夫来使cell的添加或者删除动画与decoration view的添加与删除动画保持同步。</p>
<blockquote>
<p>footerReferenceSize and headerReferenceSize During layout, only the size that corresponds to the appropriate scrolling direction is used. For example, for the vertical scrolling direction, the layout object uses the height value returned by your method. (In that instance, the width of the header would be set to the width of the collection view.) If the size in the appropriate scrolling dimension is 0, no header is added.</p>
</blockquote>
<h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><p>UICollectionViewLayoutAttributes使用场景，个人总结如下：<br>1.与DataSource无关，但想控制UIReusableView或者UICollectionViewCell的显示属性，例如在ViewController中配置UIImageView的显示模式。<br>2.UICollectionviewCell的某一属性需要跟随UICollectionViewLayout的改变而改变，例如CoverFlow类型的展示。</p>
<hr>
<p>如果觉得本文对你有帮助，就请用微信随意打赏我吧^_^</p>
<div class="figure " style="width:174px;"><img class="fig-img" src="/img/wechat_appreciate_qrcode.jpeg" style="width:174px;height:174px;"alt=""></div>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/UICollectionView/" rel="tag">UICollectionView</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/UICollectionViewLayoutAttributes/" rel="tag">UICollectionViewLayoutAttributes</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/iOS/" rel="tag">iOS</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/08/18/ios-attribute-section/"
                    data-tooltip="__attribute__"
                    aria-label="PREVIOUS: __attribute__"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/11/09/ios-system-presentation/"
                    data-tooltip="iOS中的系统转场"
                    aria-label="NEXT: iOS中的系统转场"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 CaryaLiu. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/08/18/ios-attribute-section/"
                    data-tooltip="__attribute__"
                    aria-label="PREVIOUS: __attribute__"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2016/11/09/ios-system-presentation/"
                    data-tooltip="iOS中的系统转场"
                    aria-label="NEXT: iOS中的系统转场"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">CaryaLiu</h4>
        
            <div id="about-card-bio"><p>@Chengdu，WeChat：CaryaLiu</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Teacher</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Chengdu
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-cs5ywvosncuchmfbylvxzu6rf0pcfv37ilsjrqcvnjbcjeqx9g2hzm1ygmp1.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
