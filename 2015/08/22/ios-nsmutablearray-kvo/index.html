
<!DOCTYPE html>
<html lang="en,zh-CN,default">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="CaryaLiu&#39;s blog">
    <title>iOS如何为NSMutableArray添加KVO - CaryaLiu&#39;s blog</title>
    <meta name="author" content="CaryaLiu">
    
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"CaryaLiu","sameAs":[],"image":"header.png"},"articleBody":"在项目，可能会有需求需要监听 NSMutableArray 的变化，例如在可变数组中加入、删除或者替换了元素，我们需要根据这些变化来更新UI或者做其他操作。\n那么如何来监听呢？\n方法1，使用 mutableArrayValueForKey: 代理，这样，我们在获取定义的数组属性时不再使用其 getter 方法，而是通过代理方法获取数组属性后，再对数组进行增删改的操作。这是最简单高效的方法，使用示例如下:\n\n\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758#import &quot;ViewController.h&quot;#import &quot;Student.h&quot;#import &quot;ViewModel.h&quot;static void *xxcontext = &amp;xxcontext;@interface ViewController ()@property (strong, nonatomic) ViewModel *viewModel;@end@implementation ViewController- (void)viewDidLoad &#123;    [super viewDidLoad];        self.viewModel = [[ViewModel alloc] init];    [self.viewModel addObserver:self forKeyPath:@&quot;students&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:xxcontext];&#125;- (void)didReceiveMemoryWarning &#123;    [super didReceiveMemoryWarning];    // Dispose of any resources that can be recreated.&#125;- (void)dealloc &#123;    [self.viewModel removeObserver:self forKeyPath:@&quot;students&quot;];&#125;- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context &#123;    if (context == xxcontext) &#123;        if ([keyPath isEqualToString:@&quot;students&quot;]) &#123;            NSNumber *kind = change[NSKeyValueChangeKindKey];            NSArray *students = change[NSKeyValueChangeNewKey];            NSArray *oldStudent = change[NSKeyValueChangeOldKey];            NSIndexSet *changedIndexs = change[NSKeyValueChangeIndexesKey];                        NSLog(@&quot;kind: %@, students: %@, oldStudent: %@, changedIndexs: %@&quot;, kind, students, oldStudent, changedIndexs);        &#125;    &#125; else &#123;        [super observeValueForKeyPath:keyPath ofObject:object change:change context:context];    &#125;&#125;- (IBAction)addStudent:(id)sender &#123;        Student *st1 = [[Student alloc] initWithFirstName:@&quot;carya&quot; lastName:@&quot;liu&quot;];    Student *st2 = [[Student alloc] initWithFirstName:@&quot;cici&quot; lastName:@&quot;liu&quot;];    Student *st3 = [[Student alloc] initWithFirstName:@&quot;ted&quot; lastName:@&quot;liu&quot;];        NSArray *students = @[st1, st2, st3];    [self.viewModel addStudents:students];    [self.viewModel addStudent:st3];&#125;@end\n\n我们在 viewDidLoad 函数中注册了 viewModel 对象 students 属性的监听者，同时在 dealloc 中移除了监听者。\nViewModel 中定义了 students 属性，如下:\n@property (copy, nonatomic) NSMutableArray *students;\n主要看看 ViewModel 中添加Student对象的函数实现:\n1234567891011- (NSMutableArray *)studentsArray &#123;    return [self mutableArrayValueForKey:NSStringFromSelector(@selector(students))];&#125;- (void)addStudents:(NSArray *)students &#123;    [[self studentsArray] addObjectsFromArray:students];&#125;- (void)addStudent:(Student *)student &#123;    [[self studentsArray] addObject:student];&#125;\n\n上面的代码中，我们使用代理 mutableArrayValueForKey 替代 getter 来获取 students 属性，- (NSMutableArray *)studentsArray 类似于一个 getter 方法。\nViewController 中定义的 - (IBAction)addStudent:(id)sender 是一个按钮事件，点击该按钮，看看日志输出:\n1234567891011122015-08-25 08:17:29.216 KVO[4235:252903] kind: 2, students: (    &quot;&lt;Student: 0x7fe463c89960&gt;&quot;), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463cac290&gt;[number of indexes: 1 (in 1 ranges), indexes: (0)]2015-08-25 08:17:29.217 KVO[4235:252903] kind: 2, students: (    &quot;&lt;Student: 0x7fe463c3c120&gt;&quot;), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d308c0&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]2015-08-25 08:17:29.218 KVO[4235:252903] kind: 2, students: (    &quot;&lt;Student: 0x7fe463c1fb60&gt;&quot;), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d308c0&gt;[number of indexes: 1 (in 1 ranges), indexes: (2)]2015-08-25 08:17:29.218 KVO[4235:252903] kind: 2, students: (    &quot;&lt;Student: 0x7fe463c1fb60&gt;&quot;), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d0c0b0&gt;[number of indexes: 1 (in 1 ranges), indexes: (3)]\n从上面的示例可以看出:\n\n使用 addObjectsFromArray 向数组中添加元素时，每往数组中添加一个元素都会触发一次 KVO 的执行\n从 KVO 的通知中可以获取触发这次通知的操作类型，这里是往数组中添加元素，kind 的数值是 2，即 NSKeyValueChangeInsertion\n从 KVO 的通知中还可获取到新添加的对象以及该对象在数组中的索引值\n\n如果我们想一次性往数组中加入多个元素(如 addObjectsFromArray )，但是只想让其触发一次 KVO 的执行，怎么操作呢?\n答案是使用 NSMutableArray 的这个接口 - (void)insertObjects:(NSArray *)objects atIndexes:(NSIndexSet *)indexes, 将 ViewModel 的 - (void)addStudents:(NSArray *)students 函数实现修改成如下:\n123456- (void)addStudents:(NSArray *)students &#123;//    [[self studentsArray] addObjectsFromArray:students];        NSIndexSet *indexSet = [NSIndexSet indexSetWithIndexesInRange:NSMakeRange([self studentCount], [students count])];    [[self studentsArray] insertObjects:students atIndexes:indexSet];&#125;\n\n再次运行，就会发现 KVO 只触发了一次。\n方法2，遵从属性的 KVC 规则，实现对应操作的方法。先看看对于 NSMutableArray 类型 KVC 方面的文档:\n\nIn order to be key-value coding compliant for a mutable ordered to-many relationship you must implement the following methods:\n\n-insertObject:in&lt;Key&gt;AtIndex: or -insert&lt;Key&gt;:atIndexes:. At least one of these methods must be implemented. These are analogous to the NSMutableArray methods insertObject:atIndex: and insertObjects:atIndexes:.\n\n\n-removeObjectFrom&lt;Key&gt;AtIndex: or -remove&lt;Key&gt;AtIndexes:. At least one of these methods must be implemented. These methods correspond to the NSMutableArray methods removeObjectAtIndex: and removeObjectsAtIndexes: respectively.\n\n\n-replaceObjectIn&lt;Key&gt;AtIndex:withObject: or -replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:. Optional. Implement if benchmarking indicates that performance is an issue.\n\n\nThe -insertObject:in&lt;Key&gt;AtIndex: method is passed the object to insert, and an NSUInteger that specifies the index where it should be inserted. The -insert&lt;Key&gt;:atIndexes: method inserts an array of objects into the collection at the indices specified by the passed NSIndexSet. You are only required to implement one of these two methods.\n对于上述文档，个人简单理解为，要实现 NSMutableArray 的增删改操作遵从 KVC 的规则，需要实现其对应方法:\n\n增操作 -insertObject:in&lt;Key&gt;AtIndex: 或者 -insert&lt;Key&gt;:atIndexes:\n删操作 -removeObjectFrom&lt;Key&gt;AtIndex: 或者 -remove&lt;Key&gt;AtIndexes:\n改操作 -replaceObjectIn&lt;Key&gt;AtIndex:withObject: 或者 -replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:\n\n并将这些接口暴露给调用者，在对数组进行操作时需使用上述实现的接口。\n对于方法1中提到的实例，如果想让往 ViewModel 的 students 数组添加元素时触发 KVO 通知的发送，需像如下代码实现上述方法:\n1234567891011- (NSUInteger)studentCount &#123;    return [self.students count];&#125;- (void)insertStudents:(NSArray *)array atIndexes:(NSIndexSet *)indexes &#123;    [self.students insertObjects:array atIndexes:indexes];&#125;- (void)insertObject:(Student *)object inStudentsAtIndex:(NSUInteger)index &#123;    [self.students insertObject:object atIndex:index];&#125;\n\nViewController 中添加新元素的按钮事件实现更改成如下:\n1234567891011- (IBAction)addStudent:(id)sender &#123;    Student *st1 = [[Student alloc] initWithFirstName:@&quot;carya&quot; lastName:@&quot;liu&quot;];    Student *st2 = [[Student alloc] initWithFirstName:@&quot;cici&quot; lastName:@&quot;liu&quot;];    Student *st3 = [[Student alloc] initWithFirstName:@&quot;ted&quot; lastName:@&quot;liu&quot;];    NSArray *students = @[st1, st2, st3];//    [self.viewModel addStudents:students];//    [self.viewModel addStudent:st3];        NSIndexSet *indexSet = [NSIndexSet indexSetWithIndexesInRange:NSMakeRange([self.viewModel studentCount], [students count])];    [self.viewModel insertStudents:students atIndexes:indexSet];&#125;\n\n编译重新运行示例，控制台日志输出如下:\n123452015-08-25 20:50:35.324 KVO[6483:294703] kind: 2, students: (    &quot;&lt;Student: 0x7f8508684de0&gt;&quot;,    &quot;&lt;Student: 0x7f8508684e00&gt;&quot;,    &quot;&lt;Student: 0x7f850863d690&gt;&quot;), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7f850863d6b0&gt;[number of indexes: 3 (in 1 ranges), indexes: (0-2)]\n\n从日志中可以看出，KVO 的通知只触发了一次，从 KVO 的通知中获取到了新添加的3个元素以及新元素在数组中索引。\n监听 NSMutableArray 内元素变化的 KVO 总结:\n\n使用 mutableArrayValueForKey: 代理来获取 NSMutableArray 属性\n实现 NSMutableArray 属性遵从 KVC 规则的方法，并将这些方法暴露给调用者\n\n另外，从 NSKeyValueCoding Protocol Reference 中可以看出，对于 NSMutableSet 和 NSMutableOrderedSet 也有其代理方法。\n参考:\n\nKey-Value Observing Programming Guide\nKey-Value Coding Programming Guide\n\n\n如果觉得本文对你有帮助，就请用微信打赏我吧^_^\n\n\n\n","dateCreated":"2015-08-22T09:44:34+08:00","dateModified":"2015-10-20T21:33:46+08:00","datePublished":"2015-08-22T09:44:34+08:00","description":"在项目，可能会有需求需要监听 NSMutableArray 的变化，例如在可变数组中加入、删除或者替换了元素，我们需要根据这些变化来更新UI或者做其他操作。\n那么如何来监听呢？\n方法1，使用 mutableArrayValueForKey: 代理，这样，我们在获取定义的数组属性时不再使用其 getter 方法，而是通过代理方法获取数组属性后，再对数组进行增删改的操作。这是最简单高效的方法，使用示例如下:","headline":"iOS如何为NSMutableArray添加KVO","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"},"publisher":{"@type":"Organization","name":"CaryaLiu","sameAs":[],"image":"header.png","logo":{"@type":"ImageObject","url":"header.png"}},"url":"http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/","keywords":"iOS, KVO"}</script>
    <meta name="description" content="在项目，可能会有需求需要监听 NSMutableArray 的变化，例如在可变数组中加入、删除或者替换了元素，我们需要根据这些变化来更新UI或者做其他操作。 那么如何来监听呢？ 方法1，使用 mutableArrayValueForKey: 代理，这样，我们在获取定义的数组属性时不再使用其 getter 方法，而是通过代理方法获取数组属性后，再对数组进行增删改的操作。这是最简单高效的方法，使用示例">
<meta property="og:type" content="blog">
<meta property="og:title" content="iOS如何为NSMutableArray添加KVO">
<meta property="og:url" content="http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/index.html">
<meta property="og:site_name" content="CaryaLiu&#39;s blog">
<meta property="og:description" content="在项目，可能会有需求需要监听 NSMutableArray 的变化，例如在可变数组中加入、删除或者替换了元素，我们需要根据这些变化来更新UI或者做其他操作。 那么如何来监听呢？ 方法1，使用 mutableArrayValueForKey: 代理，这样，我们在获取定义的数组属性时不再使用其 getter 方法，而是通过代理方法获取数组属性后，再对数组进行增删改的操作。这是最简单高效的方法，使用示例">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://7jpr4u.com1.z0.glb.clouddn.com/weixinpay/weixin_3_5.png">
<meta property="article:published_time" content="2015-08-22T01:44:34.000Z">
<meta property="article:modified_time" content="2015-10-20T13:33:46.000Z">
<meta property="article:author" content="CaryaLiu">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="KVO">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://7jpr4u.com1.z0.glb.clouddn.com/weixinpay/weixin_3_5.png">
    
    
        
    
    
        <meta property="og:image" content="http://liumh.com/assets/images/header.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-m6nivvurtlevuhwfo3cagj3wjhzynetfsx9hangffcjz4rld46wsu1znmnqb.min.css">

    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            CaryaLiu&#39;s blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">CaryaLiu</h4>
                
                    <h5 class="sidebar-profile-bio"><p>@Chengdu</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            iOS如何为NSMutableArray添加KVO
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2015-08-22T09:44:34+08:00">
	
		    Aug 22, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>在项目，可能会有需求需要监听 NSMutableArray 的变化，例如在可变数组中加入、删除或者替换了元素，我们需要根据这些变化来更新UI或者做其他操作。</p>
<p>那么如何来监听呢？</p>
<p>方法1，使用 <code>mutableArrayValueForKey:</code> 代理，这样，我们在获取定义的数组属性时不再使用其 <code>getter</code> 方法，而是通过代理方法获取数组属性后，再对数组进行增删改的操作。这是最简单高效的方法，使用示例如下:</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &quot;Student.h&quot;</span><br><span class="line">#import &quot;ViewModel.h&quot;</span><br><span class="line"></span><br><span class="line">static void *xxcontext = &amp;xxcontext;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@property (strong, nonatomic) ViewModel *viewModel;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    self.viewModel = [[ViewModel alloc] init];</span><br><span class="line">    [self.viewModel addObserver:self forKeyPath:@&quot;students&quot; options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld context:xxcontext];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didReceiveMemoryWarning &#123;</span><br><span class="line">    [super didReceiveMemoryWarning];</span><br><span class="line">    // Dispose of any resources that can be recreated.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    [self.viewModel removeObserver:self forKeyPath:@&quot;students&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context &#123;</span><br><span class="line">    if (context == xxcontext) &#123;</span><br><span class="line">        if ([keyPath isEqualToString:@&quot;students&quot;]) &#123;</span><br><span class="line">            NSNumber *kind = change[NSKeyValueChangeKindKey];</span><br><span class="line">            NSArray *students = change[NSKeyValueChangeNewKey];</span><br><span class="line">            NSArray *oldStudent = change[NSKeyValueChangeOldKey];</span><br><span class="line">            NSIndexSet *changedIndexs = change[NSKeyValueChangeIndexesKey];</span><br><span class="line">            </span><br><span class="line">            NSLog(@&quot;kind: %@, students: %@, oldStudent: %@, changedIndexs: %@&quot;, kind, students, oldStudent, changedIndexs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [super observeValueForKeyPath:keyPath ofObject:object change:change context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (IBAction)addStudent:(id)sender &#123;</span><br><span class="line">    </span><br><span class="line">    Student *st1 = [[Student alloc] initWithFirstName:@&quot;carya&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    Student *st2 = [[Student alloc] initWithFirstName:@&quot;cici&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    Student *st3 = [[Student alloc] initWithFirstName:@&quot;ted&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    </span><br><span class="line">    NSArray *students = @[st1, st2, st3];</span><br><span class="line">    [self.viewModel addStudents:students];</span><br><span class="line">    [self.viewModel addStudent:st3];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>我们在 <code>viewDidLoad</code> 函数中注册了 viewModel 对象 students 属性的监听者，同时在 <code>dealloc</code> 中移除了监听者。</p>
<p><code>ViewModel</code> 中定义了 <code>students</code> 属性，如下:</p>
<p><code>@property (copy, nonatomic) NSMutableArray *students;</code></p>
<p>主要看看 <code>ViewModel</code> 中添加Student对象的函数实现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableArray *)studentsArray &#123;</span><br><span class="line">    return [self mutableArrayValueForKey:NSStringFromSelector(@selector(students))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)addStudents:(NSArray *)students &#123;</span><br><span class="line">    [[self studentsArray] addObjectsFromArray:students];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)addStudent:(Student *)student &#123;</span><br><span class="line">    [[self studentsArray] addObject:student];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码中，我们使用代理 <code>mutableArrayValueForKey</code> 替代 <code>getter</code> 来获取 <code>students</code> 属性，<code>- (NSMutableArray *)studentsArray</code> 类似于一个 <code>getter</code> 方法。</p>
<p>ViewController 中定义的 <code>- (IBAction)addStudent:(id)sender</code> 是一个按钮事件，点击该按钮，看看日志输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2015-08-25 08:17:29.216 KVO[4235:252903] kind: 2, students: (</span><br><span class="line">    &quot;&lt;Student: 0x7fe463c89960&gt;&quot;</span><br><span class="line">), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463cac290&gt;[number of indexes: 1 (in 1 ranges), indexes: (0)]</span><br><span class="line">2015-08-25 08:17:29.217 KVO[4235:252903] kind: 2, students: (</span><br><span class="line">    &quot;&lt;Student: 0x7fe463c3c120&gt;&quot;</span><br><span class="line">), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d308c0&gt;[number of indexes: 1 (in 1 ranges), indexes: (1)]</span><br><span class="line">2015-08-25 08:17:29.218 KVO[4235:252903] kind: 2, students: (</span><br><span class="line">    &quot;&lt;Student: 0x7fe463c1fb60&gt;&quot;</span><br><span class="line">), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d308c0&gt;[number of indexes: 1 (in 1 ranges), indexes: (2)]</span><br><span class="line">2015-08-25 08:17:29.218 KVO[4235:252903] kind: 2, students: (</span><br><span class="line">    &quot;&lt;Student: 0x7fe463c1fb60&gt;&quot;</span><br><span class="line">), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7fe463d0c0b0&gt;[number of indexes: 1 (in 1 ranges), indexes: (3)]</span><br></pre></td></tr></table></figure>
<p>从上面的示例可以看出:</p>
<ul>
<li>使用 <code>addObjectsFromArray</code> 向数组中添加元素时，每往数组中添加一个元素都会触发一次 KVO 的执行</li>
<li>从 KVO 的通知中可以获取触发这次通知的操作类型，这里是往数组中添加元素，kind 的数值是 2，即 <code>NSKeyValueChangeInsertion</code></li>
<li>从 KVO 的通知中还可获取到新添加的对象以及该对象在数组中的索引值</li>
</ul>
<p>如果我们想一次性往数组中加入多个元素(如 <code>addObjectsFromArray</code> )，但是只想让其触发一次 KVO 的执行，怎么操作呢?</p>
<p>答案是使用 NSMutableArray 的这个接口 <code>- (void)insertObjects:(NSArray *)objects atIndexes:(NSIndexSet *)indexes</code>, 将 ViewModel 的 <code>- (void)addStudents:(NSArray *)students</code> 函数实现修改成如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void)addStudents:(NSArray *)students &#123;</span><br><span class="line">//    [[self studentsArray] addObjectsFromArray:students];</span><br><span class="line">    </span><br><span class="line">    NSIndexSet *indexSet = [NSIndexSet indexSetWithIndexesInRange:NSMakeRange([self studentCount], [students count])];</span><br><span class="line">    [[self studentsArray] insertObjects:students atIndexes:indexSet];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行，就会发现 KVO 只触发了一次。</p>
<p>方法2，遵从属性的 KVC 规则，实现对应操作的方法。先看看对于 NSMutableArray 类型 KVC 方面的文档:</p>
<blockquote>
<p>In order to be key-value coding compliant for a mutable ordered to-many relationship you must implement the following methods:</p>
</blockquote>
<p><code>-insertObject:in&lt;Key&gt;AtIndex:</code> or <code>-insert&lt;Key&gt;:atIndexes:</code>. At least one of these methods must be implemented. These are analogous to the NSMutableArray methods <code>insertObject:atIndex:</code> and <code>insertObjects:atIndexes:</code>.</p>
<blockquote>
</blockquote>
<p><code>-removeObjectFrom&lt;Key&gt;AtIndex:</code> or <code>-remove&lt;Key&gt;AtIndexes:</code>. At least one of these methods must be implemented. These methods correspond to the NSMutableArray methods <code>removeObjectAtIndex:</code> and <code>removeObjectsAtIndexes:</code> respectively.</p>
<blockquote>
</blockquote>
<p><code>-replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code> or <code>-replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:</code>. Optional. Implement if benchmarking indicates that performance is an issue.</p>
<blockquote>
</blockquote>
<p>The <code>-insertObject:in&lt;Key&gt;AtIndex:</code> method is passed the object to insert, and an NSUInteger that specifies the index where it should be inserted. The <code>-insert&lt;Key&gt;:atIndexes:</code> method inserts an array of objects into the collection at the indices specified by the passed NSIndexSet. You are only required to implement one of these two methods.</p>
<p>对于上述文档，个人简单理解为，要实现 NSMutableArray 的增删改操作遵从 KVC 的规则，需要实现其对应方法:</p>
<ul>
<li>增操作 <code>-insertObject:in&lt;Key&gt;AtIndex:</code> 或者 <code>-insert&lt;Key&gt;:atIndexes:</code></li>
<li>删操作 <code>-removeObjectFrom&lt;Key&gt;AtIndex:</code> 或者 <code>-remove&lt;Key&gt;AtIndexes:</code></li>
<li>改操作 <code>-replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code> 或者 <code>-replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:</code></li>
</ul>
<p>并将这些接口暴露给调用者，在对数组进行操作时需使用上述实现的接口。</p>
<p>对于方法1中提到的实例，如果想让往 ViewModel 的 students 数组添加元素时触发 KVO 通知的发送，需像如下代码实现上述方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (NSUInteger)studentCount &#123;</span><br><span class="line">    return [self.students count];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)insertStudents:(NSArray *)array atIndexes:(NSIndexSet *)indexes &#123;</span><br><span class="line">    [self.students insertObjects:array atIndexes:indexes];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)insertObject:(Student *)object inStudentsAtIndex:(NSUInteger)index &#123;</span><br><span class="line">    [self.students insertObject:object atIndex:index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ViewController 中添加新元素的按钮事件实现更改成如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)addStudent:(id)sender &#123;</span><br><span class="line">    Student *st1 = [[Student alloc] initWithFirstName:@&quot;carya&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    Student *st2 = [[Student alloc] initWithFirstName:@&quot;cici&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    Student *st3 = [[Student alloc] initWithFirstName:@&quot;ted&quot; lastName:@&quot;liu&quot;];</span><br><span class="line">    NSArray *students = @[st1, st2, st3];</span><br><span class="line">//    [self.viewModel addStudents:students];</span><br><span class="line">//    [self.viewModel addStudent:st3];</span><br><span class="line">    </span><br><span class="line">    NSIndexSet *indexSet = [NSIndexSet indexSetWithIndexesInRange:NSMakeRange([self.viewModel studentCount], [students count])];</span><br><span class="line">    [self.viewModel insertStudents:students atIndexes:indexSet];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译重新运行示例，控制台日志输出如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2015-08-25 20:50:35.324 KVO[6483:294703] kind: 2, students: (</span><br><span class="line">    &quot;&lt;Student: 0x7f8508684de0&gt;&quot;,</span><br><span class="line">    &quot;&lt;Student: 0x7f8508684e00&gt;&quot;,</span><br><span class="line">    &quot;&lt;Student: 0x7f850863d690&gt;&quot;</span><br><span class="line">), oldStudent: (null), changedIndexs: &lt;NSIndexSet: 0x7f850863d6b0&gt;[number of indexes: 3 (in 1 ranges), indexes: (0-2)]</span><br></pre></td></tr></table></figure>

<p>从日志中可以看出，KVO 的通知只触发了一次，从 KVO 的通知中获取到了新添加的3个元素以及新元素在数组中索引。</p>
<p>监听 NSMutableArray 内元素变化的 KVO 总结:</p>
<ol>
<li>使用 <code>mutableArrayValueForKey:</code> 代理来获取 NSMutableArray 属性</li>
<li>实现 NSMutableArray 属性遵从 KVC 规则的方法，并将这些方法暴露给调用者</li>
</ol>
<p>另外，从 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Protocols/NSKeyValueCoding_Protocol/">NSKeyValueCoding Protocol Reference</a> 中可以看出，对于 NSMutableSet 和 NSMutableOrderedSet 也有其代理方法。</p>
<p>参考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html#//apple_ref/doc/uid/10000177-BCICJDHA">Key-Value Observing Programming Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/KeyValueCoding.html#//apple_ref/doc/uid/10000107-SW1">Key-Value Coding Programming Guide</a></li>
</ul>
<hr>
<p>如果觉得本文对你有帮助，就请用微信打赏我吧^_^</p>
<div class="figure " style="width:117;"><img class="fig-img" src="http://7jpr4u.com1.z0.glb.clouddn.com/weixinpay/weixin_3_5.png" style="width:117;height:174;"alt=""></div>



            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/KVO/" rel="tag">KVO</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/iOS/" rel="tag">iOS</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/08/25/ios-know-kvo/"
                    data-tooltip="iOS初探KVO"
                    aria-label="PREVIOUS: iOS初探KVO"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/08/19/tranquilpeak-add-baidu-analytics/"
                    data-tooltip="为tranquilpeak主题添加百度统计"
                    aria-label="NEXT: 为tranquilpeak主题添加百度统计"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2024 CaryaLiu. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/08/25/ios-know-kvo/"
                    data-tooltip="iOS初探KVO"
                    aria-label="PREVIOUS: iOS初探KVO"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/08/19/tranquilpeak-add-baidu-analytics/"
                    data-tooltip="为tranquilpeak主题添加百度统计"
                    aria-label="NEXT: 为tranquilpeak主题添加百度统计"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://liumh.com/2015/08/22/ios-nsmutablearray-kvo/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/header.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">CaryaLiu</h4>
        
            <div id="about-card-bio"><p>@Chengdu</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>iOS Developer</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Chengdu
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-0cj71mixkkwdp0vs8wjjkzbxkqkvcb59caculu32e29euc2z9epm5lizux6e.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
